{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\nimport { PrismaPg } from '@prisma/adapter-pg'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nconst adapter = new PrismaPg({\n  connectionString: process.env.DATABASE_URL!,\n})\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({ adapter })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,kBAAkB;AAIxB,MAAM,UAAU,IAAI,yKAAQ,CAAC;IAC3B,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IAAE;AAAQ;AAE7B,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 95, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/auth.ts"],"sourcesContent":["import bcrypt from 'bcryptjs';\nimport { SignJWT, jwtVerify } from 'jose';\nimport { cookies } from 'next/headers';\n\nconst JWT_SECRET = process.env.JWT_SECRET;\n\nif (!JWT_SECRET) {\n  throw new Error(\n    'JWT_SECRET environment variable is not set. ' +\n    'Please configure it before starting the application.'\n  );\n}\n\nexport interface JWTPayload {\n  userId: string;\n  email: string;\n  perfil: 'ADMIN' | 'MODERADOR';\n}\n\nexport async function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, 10);\n}\n\nexport async function verifyPassword(\n  password: string,\n  hashedPassword: string\n): Promise<boolean> {\n  return bcrypt.compare(password, hashedPassword);\n}\n\nexport async function signToken(payload: JWTPayload): Promise<string> {\n  const secret = new TextEncoder().encode(JWT_SECRET);\n  const token = await new SignJWT(payload as Record<string, unknown>)\n    .setProtectedHeader({ alg: 'HS256' })\n    .setExpirationTime('7d')\n    .sign(secret);\n  return token;\n}\n\nexport async function verifyToken(token: string): Promise<JWTPayload | null> {\n  try {\n    const secret = new TextEncoder().encode(JWT_SECRET);\n    const { payload } = await jwtVerify(token, secret);\n    return payload as unknown as JWTPayload;\n  } catch {\n    return null;\n  }\n}\n\nexport async function setAuthCookie(token: string) {\n  const cookieStore = await cookies();\n  cookieStore.set('auth-token', token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24 * 7, // 7 days\n    path: '/',\n  });\n}\n\nexport async function removeAuthCookie() {\n  const cookieStore = await cookies();\n  cookieStore.delete('auth-token');\n}\n\nexport async function getAuthToken(): Promise<string | undefined> {\n  const cookieStore = await cookies();\n  return cookieStore.get('auth-token')?.value;\n}\n\nexport async function getUserFromToken(request?: any): Promise<JWTPayload | null> {\n  let token = await getAuthToken();\n  \n  if (!token && request) {\n    const authHeader = request.headers?.get?.('authorization') || request.headers?.['authorization'];\n    if (authHeader?.startsWith('Bearer ')) {\n      token = authHeader.slice(7);\n    }\n  }\n  \n  if (!token) return null;\n  return verifyToken(token);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AACA;AAAA;AACA;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU;AAEzC,IAAI,CAAC,YAAY;IACf,MAAM,IAAI,MACR,iDACA;AAEJ;AAQO,eAAe,aAAa,QAAgB;IACjD,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eACpB,QAAgB,EAChB,cAAsB;IAEtB,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAEO,eAAe,UAAU,OAAmB;IACjD,MAAM,SAAS,IAAI,cAAc,MAAM,CAAC;IACxC,MAAM,QAAQ,MAAM,IAAI,kKAAO,CAAC,SAC7B,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,MAClB,IAAI,CAAC;IACR,OAAO;AACT;AAEO,eAAe,YAAY,KAAa;IAC7C,IAAI;QACF,MAAM,SAAS,IAAI,cAAc,MAAM,CAAC;QACxC,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;QAC3C,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,cAAc,KAAa;IAC/C,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,YAAY,GAAG,CAAC,cAAc,OAAO;QACnC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK,KAAK;QACvB,MAAM;IACR;AACF;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,YAAY,MAAM,CAAC;AACrB;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,OAAO,YAAY,GAAG,CAAC,eAAe;AACxC;AAEO,eAAe,iBAAiB,OAAa;IAClD,IAAI,QAAQ,MAAM;IAElB,IAAI,CAAC,SAAS,SAAS;QACrB,MAAM,aAAa,QAAQ,OAAO,EAAE,MAAM,oBAAoB,QAAQ,OAAO,EAAE,CAAC,gBAAgB;QAChG,IAAI,YAAY,WAAW,YAAY;YACrC,QAAQ,WAAW,KAAK,CAAC;QAC3B;IACF;IAEA,IAAI,CAAC,OAAO,OAAO;IACnB,OAAO,YAAY;AACrB"}},
    {"offset": {"line": 179, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/resumo-analitico.ts"],"sourcesContent":["interface DadosEvolucao {\n  score_fluencia: number;\n  score_cultura: number;\n  score_interpretacao: number;\n  score_atencao: number;\n  score_auto_percepcao: number;\n  score_total: number;\n}\n\ninterface DadosPresenca {\n  percentual: number;\n}\n\ninterface VariacaoDominio {\n  dominio: string;\n  variacao: number;\n  tendencia: 'melhora' | 'estavel' | 'queda';\n}\n\ninterface ParametrosResumo {\n  evolucao: DadosEvolucao[];\n  variacoes: VariacaoDominio[];\n  presencas?: DadosPresenca[];\n  periodoMeses: number;\n}\n\nfunction classificarVariacao(variacao: number): 'melhora' | 'estavel' | 'queda' {\n  if (variacao > 1.0) return 'melhora';\n  if (variacao < -1.0) return 'queda';\n  return 'estavel';\n}\n\nfunction formatarListaDominios(dominios: string[]): string {\n  if (dominios.length === 0) return '';\n  if (dominios.length === 1) return dominios[0];\n  if (dominios.length === 2) return `${dominios[0]} e ${dominios[1]}`;\n  const ultimo = dominios.pop();\n  return `${dominios.join(', ')} e ${ultimo}`;\n}\n\nexport function gerarResumoAnalitico({ evolucao, variacoes, presencas, periodoMeses }: ParametrosResumo): string {\n  if (evolucao.length === 0) {\n    return 'Ainda não há avaliações suficientes para gerar um resumo analítico.';\n  }\n\n  const partes: string[] = [];\n  const periodoTexto = periodoMeses === 3 ? 'nos últimos 3 meses' :\n    periodoMeses === 6 ? 'nos últimos 6 meses' :\n    periodoMeses === 12 ? 'no último ano' :\n    'no período analisado';\n\n  const melhorias = variacoes.filter(v => v.tendencia === 'melhora').map(v => v.dominio);\n  const quedas = variacoes.filter(v => v.tendencia === 'queda').map(v => v.dominio);\n  const estaveis = variacoes.filter(v => v.tendencia === 'estavel').map(v => v.dominio);\n\n  if (melhorias.length > 0) {\n    const dominiosMelhora = formatarListaDominios([...melhorias]);\n    partes.push(`${periodoTexto.charAt(0).toUpperCase() + periodoTexto.slice(1)}, o aluno apresentou melhora consistente em ${dominiosMelhora}`);\n  }\n\n  if (estaveis.length > 0 && partes.length > 0) {\n    const dominiosEstaveis = formatarListaDominios([...estaveis]);\n    partes.push(`mantendo estabilidade em ${dominiosEstaveis}`);\n  } else if (estaveis.length > 0) {\n    const dominiosEstaveis = formatarListaDominios([...estaveis]);\n    partes.push(`${periodoTexto.charAt(0).toUpperCase() + periodoTexto.slice(1)}, o aluno manteve desempenho estável em ${dominiosEstaveis}`);\n  }\n\n  if (quedas.length > 0) {\n    const dominiosQueda = formatarListaDominios([...quedas]);\n    if (partes.length > 0) {\n      partes.push(`Observa-se leve queda em ${dominiosQueda}`);\n    } else {\n      partes.push(`${periodoTexto.charAt(0).toUpperCase() + periodoTexto.slice(1)}, observa-se queda no desempenho em ${dominiosQueda}`);\n    }\n  }\n\n  if (presencas && presencas.length > 0) {\n    const mediaPresenca = presencas.reduce((sum, p) => sum + p.percentual, 0) / presencas.length;\n    \n    if (mediaPresenca < 70 && quedas.length > 0) {\n      partes.push('coincidindo com redução na frequência às sessões no período');\n    } else if (mediaPresenca >= 85) {\n      partes.push('O aluno demonstrou excelente engajamento, com presença regular nas sessões');\n    } else if (mediaPresenca < 60) {\n      partes.push('A frequência reduzida às sessões pode estar impactando o desenvolvimento cognitivo');\n    }\n  }\n\n  if (partes.length === 0) {\n    return 'O aluno apresenta desempenho dentro dos parâmetros esperados, sem variações significativas no período.';\n  }\n\n  let texto = partes.join('. ');\n  if (!texto.endsWith('.')) {\n    texto += '.';\n  }\n\n  return texto;\n}\n\nexport function calcularVariacoes(evolucao: DadosEvolucao[], mesAtual: number): VariacaoDominio[] {\n  if (evolucao.length < 2) {\n    return [];\n  }\n\n  const ultimo = evolucao[evolucao.length - 1];\n  const indicePeriodo = Math.max(0, evolucao.length - mesAtual - 1);\n  const referencia = evolucao[indicePeriodo] || evolucao[0];\n\n  const dominios = [\n    { key: 'score_fluencia', nome: 'Fluência' },\n    { key: 'score_cultura', nome: 'Cultura' },\n    { key: 'score_interpretacao', nome: 'Interpretação' },\n    { key: 'score_atencao', nome: 'Atenção' },\n    { key: 'score_auto_percepcao', nome: 'Auto-percepção' },\n    { key: 'score_total', nome: 'Total' },\n  ];\n\n  return dominios.map(d => {\n    const atual = ultimo[d.key as keyof DadosEvolucao] || 0;\n    const anterior = referencia[d.key as keyof DadosEvolucao] || 0;\n    const variacao = atual - anterior;\n    return {\n      dominio: d.nome,\n      variacao,\n      tendencia: classificarVariacao(variacao),\n    };\n  });\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 302, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/moderador/relatorios/aluno/%5BalunoId%5D/completo/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\nimport { getUserFromToken } from '@/lib/auth';\nimport { gerarResumoAnalitico, calcularVariacoes } from '@/lib/resumo-analitico';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ alunoId: string }> }\n) {\n  try {\n    const { alunoId } = await params;\n\n    const user = await getUserFromToken();\n    if (!user || user.perfil !== 'MODERADOR') {\n      return NextResponse.json({ error: 'Não autorizado' }, { status: 401 });\n    }\n\n    const aluno = await prisma.aluno.findFirst({\n      where: {\n        id: alunoId,\n        turma: { moderadorId: user.userId },\n      },\n      include: { turma: true },\n    });\n\n    if (!aluno) {\n      return NextResponse.json({ error: 'Aluno não encontrado ou não pertence às suas turmas' }, { status: 404 });\n    }\n\n    const { searchParams } = new URL(request.url);\n    const periodo = searchParams.get('periodo') || '6m';\n\n    let dataInicio: Date | null = null;\n    const agora = new Date();\n    if (periodo === '3m') {\n      dataInicio = new Date(agora.getFullYear(), agora.getMonth() - 3, 1);\n    } else if (periodo === '6m') {\n      dataInicio = new Date(agora.getFullYear(), agora.getMonth() - 6, 1);\n    } else if (periodo === '12m') {\n      dataInicio = new Date(agora.getFullYear(), agora.getMonth() - 12, 1);\n    }\n\n    const whereAvaliacao: Record<string, unknown> = { alunoId, status: 'CONCLUIDA' };\n    if (dataInicio) {\n      whereAvaliacao.OR = [\n        { ano_referencia: { gt: dataInicio.getFullYear() } },\n        {\n          ano_referencia: dataInicio.getFullYear(),\n          mes_referencia: { gte: dataInicio.getMonth() + 1 },\n        },\n      ];\n    }\n\n    const avaliacoes = await prisma.avaliacao.findMany({\n      where: whereAvaliacao,\n      orderBy: [{ ano_referencia: 'asc' }, { mes_referencia: 'asc' }],\n    });\n\n    const evolucao = avaliacoes.map((av) => ({\n      mes_ano: `${String(av.mes_referencia).padStart(2, '0')}/${av.ano_referencia}`,\n      score_total: av.score_total,\n      score_fluencia: av.score_fluencia_0a10,\n      score_cultura: av.score_cultura_0a10,\n      score_interpretacao: av.score_interpretacao_0a10,\n      score_atencao: av.score_atencao_0a10,\n      score_auto_percepcao: av.score_auto_percepcao_0a10,\n    }));\n\n    const evolucaoComMediaMovel = evolucao.map((item, idx, arr) => {\n      if (idx < 2) return { ...item, media_movel: item.score_total };\n      const soma = arr[idx].score_total + arr[idx - 1].score_total + arr[idx - 2].score_total;\n      return { ...item, media_movel: soma / 3 };\n    });\n\n    const ultimaAvaliacao = avaliacoes[avaliacoes.length - 1];\n    \n    let radar: Array<{ dominio: string; aluno: number; media?: number }> = [];\n    let temMediaTurma = false;\n\n    if (ultimaAvaliacao) {\n      const alunoRadar = [\n        { dominio: 'Fluência', aluno: ultimaAvaliacao.score_fluencia_0a10 },\n        { dominio: 'Cultura', aluno: ultimaAvaliacao.score_cultura_0a10 },\n        { dominio: 'Interpretação', aluno: ultimaAvaliacao.score_interpretacao_0a10 },\n        { dominio: 'Atenção', aluno: ultimaAvaliacao.score_atencao_0a10 },\n        { dominio: 'Auto-percepção', aluno: ultimaAvaliacao.score_auto_percepcao_0a10 },\n      ];\n\n      const avaliacoesTurma = await prisma.avaliacao.findMany({\n        where: {\n          turmaId: aluno.turmaId,\n          mes_referencia: ultimaAvaliacao.mes_referencia,\n          ano_referencia: ultimaAvaliacao.ano_referencia,\n          status: 'CONCLUIDA',\n          alunoId: { not: alunoId },\n        },\n      });\n\n      if (avaliacoesTurma.length > 0) {\n        temMediaTurma = true;\n        const mediaTurma = {\n          fluencia: avaliacoesTurma.reduce((s, a) => s + a.score_fluencia_0a10, 0) / avaliacoesTurma.length,\n          cultura: avaliacoesTurma.reduce((s, a) => s + a.score_cultura_0a10, 0) / avaliacoesTurma.length,\n          interpretacao: avaliacoesTurma.reduce((s, a) => s + a.score_interpretacao_0a10, 0) / avaliacoesTurma.length,\n          atencao: avaliacoesTurma.reduce((s, a) => s + a.score_atencao_0a10, 0) / avaliacoesTurma.length,\n          auto_percepcao: avaliacoesTurma.reduce((s, a) => s + a.score_auto_percepcao_0a10, 0) / avaliacoesTurma.length,\n        };\n\n        radar = alunoRadar.map((item, idx) => ({\n          ...item,\n          media: [mediaTurma.fluencia, mediaTurma.cultura, mediaTurma.interpretacao, mediaTurma.atencao, mediaTurma.auto_percepcao][idx],\n        }));\n      } else {\n        radar = alunoRadar;\n      }\n    }\n\n    const presencas = await prisma.presenca.findMany({\n      where: {\n        alunoId,\n        data: dataInicio ? { gte: dataInicio } : undefined,\n      },\n      orderBy: { data: 'asc' },\n    });\n\n    const presencasPorMes: Record<string, { presencas: number; total: number }> = {};\n    presencas.forEach((p) => {\n      const mesAno = `${String(p.data.getMonth() + 1).padStart(2, '0')}/${p.data.getFullYear()}`;\n      if (!presencasPorMes[mesAno]) {\n        presencasPorMes[mesAno] = { presencas: 0, total: 0 };\n      }\n      presencasPorMes[mesAno].total++;\n      if (p.presente) {\n        presencasPorMes[mesAno].presencas++;\n      }\n    });\n\n    const dadosPresenca = Object.entries(presencasPorMes).map(([mesAno, dados]) => ({\n      mes_ano: mesAno,\n      presencas: dados.presencas,\n      total_sessoes: dados.total,\n      percentual: dados.total > 0 ? (dados.presencas / dados.total) * 100 : 0,\n    }));\n\n    const mesAtual = new Date().getMonth() + 1;\n    const anoAtual = new Date().getFullYear();\n    const chaveMesAtual = `${String(mesAtual).padStart(2, '0')}/${anoAtual}`;\n    const presencaMesAtual = presencasPorMes[chaveMesAtual] || { presencas: 0, total: 0 };\n\n    const totalPresencas = dadosPresenca.reduce((s, p) => s + p.presencas, 0);\n    const totalSessoes = dadosPresenca.reduce((s, p) => s + p.total_sessoes, 0);\n    const presencaMedia6Meses = totalSessoes > 0 ? (totalPresencas / totalSessoes) * 100 : 0;\n\n    const eventos = await prisma.eventoAluno.findMany({\n      where: {\n        alunoId,\n        data: dataInicio ? { gte: dataInicio } : undefined,\n      },\n      orderBy: { data: 'desc' },\n    });\n\n    const eventosComMesAno = eventos.map(e => ({\n      ...e,\n      mes_ano: `${String(e.data.getMonth() + 1).padStart(2, '0')}/${e.data.getFullYear()}`,\n    }));\n\n    const evolucaoComEventos = evolucaoComMediaMovel.map(item => {\n      const eventoDoMes = eventosComMesAno.find(e => e.mes_ano === item.mes_ano);\n      return {\n        ...item,\n        evento: eventoDoMes ? { titulo: eventoDoMes.titulo, tipo: eventoDoMes.tipo } : undefined,\n      };\n    });\n\n    const periodoMeses = periodo === '3m' ? 3 : periodo === '6m' ? 6 : periodo === '12m' ? 12 : evolucao.length;\n    const variacoes = calcularVariacoes(evolucao, periodoMeses);\n    \n    const cardsResumo = variacoes.map(v => {\n      const atual = evolucao.length > 0 ? evolucao[evolucao.length - 1] : null;\n      const anterior = evolucao.length > periodoMeses ? evolucao[evolucao.length - periodoMeses - 1] : evolucao[0];\n      \n      const keyMap: Record<string, string> = {\n        'Total': 'score_total',\n        'Fluência': 'score_fluencia',\n        'Cultura': 'score_cultura',\n        'Interpretação': 'score_interpretacao',\n        'Atenção': 'score_atencao',\n        'Auto-percepção': 'score_auto_percepcao',\n      };\n      const key = keyMap[v.dominio] as keyof typeof atual;\n      \n      return {\n        dominio: v.dominio,\n        atual: atual ? (atual[key] as number) : 0,\n        anterior: anterior ? (anterior[key] as number) : 0,\n        variacao: v.variacao,\n        tendencia: v.tendencia,\n      };\n    });\n\n    const resumoTexto = gerarResumoAnalitico({\n      evolucao,\n      variacoes,\n      presencas: dadosPresenca,\n      periodoMeses,\n    });\n\n    return NextResponse.json({\n      aluno: { id: aluno.id, nome: aluno.nome, turma: aluno.turma.nome_turma },\n      evolucao: evolucaoComEventos,\n      radar,\n      temMediaTurma,\n      cardsResumo,\n      presenca: {\n        dados: dadosPresenca,\n        mesAtual: presencaMesAtual,\n        media6Meses: presencaMedia6Meses,\n      },\n      eventos: eventos.map(e => ({\n        id: e.id,\n        data: e.data.toISOString(),\n        titulo: e.titulo,\n        descricao: e.descricao,\n        tipo: e.tipo,\n      })),\n      resumoTexto,\n    });\n  } catch (error) {\n    console.error('Erro ao gerar relatório completo:', error);\n    return NextResponse.json({ error: 'Erro interno' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}